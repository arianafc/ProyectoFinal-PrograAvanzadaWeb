@model SIGEP_ProyectoFinal.Models.VacantePracticaModel

@{
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
    ViewBag.Title = "Vacantes - Prácticas";
    var rol = ViewBag.Rol;
    var nombre = ViewBag.Nombre as string;
    var usuario = ViewBag.IdUsuario;

    // Validar si es del año actual
    int anioActual = DateTime.Now.Year;
    int anioPractica = Model.FechaAplicacion.HasValue ? Model.FechaAplicacion.Value.Year : 0;
    bool esAnioActual = anioPractica == anioActual;
}

@* Manejar caso cuando el estudiante no tiene práctica *@
@if (ViewBag.SinPractica != null && ViewBag.SinPractica)
{
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-white text-center">
                        <h4><i class="fas fa-exclamation-triangle"></i> Sin Práctica Asignada</h4>
                    </div>
                    <div class="card-body text-center">
                        <p class="card-text">@ViewBag.Mensaje</p>
                        <p>Mantente atento a las actualizaciones del sistema.</p>
                        <a href="@Url.Action("Index", "Home")" class="btn btn-primary">Volver al Inicio</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    if (rol == 2 || rol == 3)
    {
        <h2 class="vacantes-titulo titulo-principal d-flex justify-content-center align-items-center">
            Proceso de Aplicación - @(Model?.EstudianteNombre ?? "Estudiante")
        </h2>
    }
    if (rol == 1)
    {
        <h2 class="vacantes-titulo titulo-principal d-flex justify-content-center align-items-center">
            Mi Práctica - @(Model?.EstudianteNombre ?? "Estudiante")
        </h2>
    }
}

<!-- Campo oculto para el rol -->
<input type="hidden" id="rolUsuario" value="@rol" />
<input type="hidden" id="idPractica" value="@Model.IdPractica" />

<div class="d-flex flex-wrap justify-content-between" style="gap: 2rem;">
    <!-- Columna Izquierda: Información General -->
    <div class="card p-4 shadow mb-4" style="flex: 1 1 48%;">
        <div class="row mb-3">
            <h3 class="section-title">Información General</h3>
        </div>
        <div class="row g-4 justify-content-between">
            <!-- Columna de Vacante -->
            <div class="col-md-6">
                <div class="card shadow-sm p-3" style="border-radius: 12px; background-color: #F9F9F9;">
                    @if (rol == 2 || rol == 3)
                    {
                        <h5 class="mb-3" style="color: #2D594D;"><strong>Información de Vacante</strong></h5>
                    }
                    @if (rol == 1)
                    {
                        <h5 class="mb-3" style="color: #2D594D;"><strong>Información del Puesto</strong></h5>
                    }
                    <div class="mb-2">
                        <label class="form-label text-muted"><strong>Nombre</strong></label><br />
                        <span>@(Model?.Nombre ?? "No disponible")</span>
                    </div>
                    <div class="mb-2">
                        <label class="form-label text-muted"><strong>Empresa</strong></label><br />
                        <span>@(Model?.EmpresaNombre ?? "No disponible")</span>
                    </div>
                    <div class="mb-2">
                        <label class="form-label text-muted"><strong>Requerimientos</strong></label><br />
                        <span>@(Model?.Requerimientos ?? "No especificados")</span>
                    </div>
                    <div class="mb-2">
                        <label class="form-label text-muted"><strong>Fecha de Aplicación</strong></label><br />
                        <span>@(Model?.FechaAplicacion?.ToString("dd-MM-yyyy") ?? "No disponible")</span>
                    </div>
                    <div class="mb-2">
                        <label class="form-label text-muted"><strong>Modalidad</strong></label><br />
                        <span>@(Model?.ModalidadNombre ?? "No especificada")</span>
                    </div>
                </div>
            </div>

            <!-- Columna de Estudiante -->
            <div class="col-md-6">
                <div class="card shadow-sm p-3" style="border-radius: 12px; background-color: #F9F9F9;">
                    @if (rol == 2 || rol == 3)
                    {
                        <h5 class="mb-3" style="color: #2D594D;"><strong>Información del Estudiante</strong></h5>
                    }
                    @if (rol == 1)
                    {
                        <h5 class="mb-3" style="color: #2D594D;"><strong>Mi Información</strong></h5>
                    }
                    <div class="mb-2">
                        <label class="form-label text-muted"><strong>Nombre</strong></label><br />
                        <span>@(Model?.EstudianteNombre ?? "No disponible")</span>
                    </div>
                    <div class="mb-2">
                        <label class="form-label text-muted"><strong>Cédula</strong></label><br />
                        <span>@(Model?.EstudianteCedula ?? "No disponible")</span>
                    </div>
                    <div class="mb-2">
                        <label class="form-label text-muted"><strong>Correo</strong></label><br />
                        <span>@(Model?.EstudianteCorreo ?? "No disponible")</span>
                    </div>
                    <div class="mb-2">
                        <label class="form-label text-muted"><strong>Especialidad</strong></label><br />
                        <span>@(Model?.EstudianteEspecialidad ?? "No especificada")</span>
                    </div>
                    <div class="mb-2">
                        <label class="form-label text-muted"><strong>Edad</strong></label><br />
                        <span>@(Model?.EstudianteEdad.ToString() ?? "No disponible") años</span>
                    </div>
                </div>
            </div>
        </div>

        <hr />
        @if (rol == 2 || rol == 3)
        {
            <h3 class="section-title">Información de Contacto</h3>
        }
        @if (rol == 1)
        {
            <h3 class="section-title">Contacto con la Empresa</h3>
        }
        <div class="mb-2"><label style="color: #2D594D"><strong>Contacto en la empresa</strong></label><br /><span>@(Model?.ContactoEmpresaNombre ?? "No disponible")</span></div>
        <div class="mb-2"><label style="color: #2D594D"><strong>Email</strong></label><br /><span>@(Model?.ContactoEmpresaEmail ?? "No disponible")</span></div>
        <div class="mb-2"><label style="color: #2D594D"><strong>Teléfono</strong></label><br /><span>@(Model?.ContactoEmpresaTelefono ?? "No disponible")</span></div>
    </div>

    <!-- Columna Derecha: Proceso de Aplicación -->
    <div class="card p-4 shadow mb-4" style="flex: 1 1 48%;">
        @if (rol == 2 || rol == 3)
        {
            <h3 class="section-title">Proceso de Aplicación</h3>
            <h4 style="color: #2D594D; font-weight: 600;">Comentarios del Proceso</h4>
            <hr />
        }
        @if (rol == 1)
        {
            <h3 class="section-title">Proceso de la Práctica</h3>
            <h4 style="color: #2D594D; font-weight: 600;">Comentarios de la Práctica</h4>
            <hr />
        }

        <!-- Comentarios -->
        <div id="comentariosAnteriores">
            <ul class="list-unstyled">
                @if (Model?.Comentarios != null && Model.Comentarios.Any())
                {
                    foreach (var comentario in Model.Comentarios)
                    {
                        <li>
                            <strong>@comentario.Fecha.ToString("dd/MM/yyyy HH:mm") - @comentario.Usuario:</strong><br />
                            @comentario.Comentario
                        </li>
                    }
                }
                else
                {
                    <li>No hay comentarios disponibles.</li>
                }
            </ul>
        </div>

        <!-- Estado -->
        <div class="mt-4">
            <h4 style="color: #2D594D; font-weight: 600;">Estado Actual</h4>
            @{
                var estadoRaw = (Model?.EstadoPractica ?? "No disponible").Trim();
                var estadoNorm = System.Text.RegularExpressions.Regex
                .Replace(
                (estadoRaw.ToLowerInvariant()).Normalize(System.Text.NormalizationForm.FormD),
                "\\p{IsCombiningDiacriticalMarks}+",
                string.Empty
                )
                .Replace("  ", " ")
                .Trim();

                var clase = "badge badge-no-asignada";

                if (estadoNorm == "en proceso de aplicacion") { clase = "badge badge-en-progreso"; }
                else if (estadoNorm == "rechazada") { clase = "badge badge-rechazada"; }
                else if (estadoNorm == "asignada") { clase = "badge badge-asignada"; }
                else if (estadoNorm == "aprobada" || estadoNorm == "aprobado") { clase = "badge badge-aprobada"; }
                else if (estadoNorm == "retirada") { clase = "badge badge-retirada"; }
                else if (estadoNorm == "finalizada") { clase = "badge badge-finalizada"; }
                else if (estadoNorm == "rezagado") { clase = "badge badge-rezagado"; }
                else if (estadoNorm == "archivado") { clase = "badge badge-archivado"; }
                else if (estadoNorm == "en curso") { clase = "badge badge-en-curso"; }
                else if (estadoNorm == "en progreso") { clase = "badge badge-en-progreso"; }
            }
            <span class="@clase">@estadoRaw</span>
        </div>

        @if (esAnioActual)
        {
            <!-- Botones -->
            <div class="mt-4 action-buttons">
                <div class="row top-buttons">
                    <div class="col-md-6">
                        <button type="button" class="btn-verde-personalizado w-100" data-bs-toggle="modal" data-bs-target="#modalAgregarComentario">
                            Agregar Comentario
                        </button>
                    </div>
                    @if (rol == 2 || rol == 3)
                    {
                        <div class="col-md-6">
                            <button type="button" class="btn-verde-personalizado w-100" data-bs-toggle="modal" data-bs-target="#modalActualizarEstado">
                                Actualizar Estado
                            </button>
                        </div>
                    }
                </div>
            </div>
        }
        else
        {
            <br>
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Esta práctica corresponde al año @anioPractica. Solo se permite visualización.
            </div>
        }

        <!-- Evaluaciones -->
        @if (Model?.EstadoPractica == "En Curso" ||
                Model?.EstadoPractica == "Aprobada" ||
                Model?.EstadoPractica == "Finalizada" ||
                Model?.EstadoPractica == "Rezagado")
        {
            <div class="notas-readonly-card">
                <div class="notas-readonly-titulo">
                    <i class="bi bi-lock-fill"></i>
                    Evaluaciones de la Práctica
                </div>

                <div class="row g-3">
                    <!-- Nota 1 -->
                    <div class="col-md-4">
                        <div class="nota-readonly-item">
                            <span class="nota-readonly-label">Nota 1</span>
                            <span class="nota-readonly-valor @(Model.Nota1 == null ? "sin-calificar" : "")">
                                @(Model.Nota1?.ToString("F2") ?? "Sin nota")
                            </span>
                        </div>
                    </div>

                    <!-- Nota 2 -->
                    <div class="col-md-4">
                        <div class="nota-readonly-item">
                            <span class="nota-readonly-label">Nota 2</span>
                            <span class="nota-readonly-valor @(Model.Nota2 == null ? "sin-calificar" : "")">
                                @(Model.Nota2?.ToString("F2") ?? "Sin nota")
                            </span>
                        </div>
                    </div>

                    <!-- Nota Final -->
                    <div class="col-md-4">
                        <div class="nota-readonly-item nota-readonly-final">
                            <span class="nota-readonly-label">Nota Final</span>
                            <span class="nota-readonly-valor @(Model.NotaFinal == null ? "sin-calificar" : "")">
                                @(Model.NotaFinal?.ToString("F2") ?? "Sin nota")
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Modal para Actualizar Estado -->
<div class="modal fade" id="modalActualizarEstado" tabindex="-1" aria-labelledby="modalActualizarEstadoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content" style="border-radius: 12px; background-color: #F2F2F2; color: #2D594D;">
            <div class="modal-header" style="background-color: #2D594D; color: white;">
                <h5 class="modal-title">Actualizar Estado</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body px-4">
                <div class="mb-3">
                    <label for="nuevoEstado" class="form-label" style="font-size: 14px">Nuevo Estado</label>
                    <select id="nuevoEstado" name="nuevoEstado" style="font-size: 14px" class="form-select" required>
                        <option value="">Seleccione un estado</option>
                        @foreach (var estado in Model.ListaEstados)
                        {
                            <option value="@estado.IdEstado">@estado.Descripcion</option>
                        }
                    </select>
                </div>
                <div class="mb-3">
                    <label for="comentarioEstado" class="form-label">Comentario</label>
                    <textarea id="comentarioEstado" name="comentarioEstado" class="form-control" rows="4" placeholder="Agrega un comentario sobre esta actualización..." required></textarea>
                </div>
                <div class="text-end">
                    <button type="button" class="btn-verde-personalizado" id="btnActualizarEstado">Actualizar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Agregar Comentario -->
<div class="modal fade" id="modalAgregarComentario" tabindex="-1" aria-labelledby="modalAgregarComentarioLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content" style="border-radius: 12px; background-color: #F2F2F2; color: #2D594D;">
            <div class="modal-header" style="background-color: #2D594D; color: white;">
                <h5 class="modal-title">Comentarios</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body px-4">
                <div class="mb-3">
                    <label for="comentarioProceso" class="form-label">Comentario</label>
                    <textarea id="comentarioProceso" class="form-control" rows="4" placeholder="Agrega un comentario sobre el proceso de postulación..." maxlength="1000"></textarea>
                    <small class="text-muted">Máximo 1000 caracteres</small>
                </div>
                <div class="text-end">
                    <button type="button" class="btn-verde-personalizado" id="btnAgregarComentario">
                        <i class="fas fa-plus me-1"></i> Agregar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/practicas/ScriptPracticas.js" asp-append-version="true"></script>
}