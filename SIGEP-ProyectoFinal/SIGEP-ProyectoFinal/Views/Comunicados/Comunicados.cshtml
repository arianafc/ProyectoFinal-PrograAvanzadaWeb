@model Comunicado
@{
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
    var rol = ViewBag.Rol;   
    var nombre = ViewBag.Nombre as string;
    var usuario = ViewBag.IdUsuario;
}

@section Styles {
    <link href="~/css/Comunicados.css" rel="stylesheet" />
}


<input type="hidden" class="TempError" value="@TempData["SwalError"]" />
<input type="hidden" class="TempSuccess" value="@TempData["SwalSuccess"]" />


<div class="comunicados-wrapper">
    <h2 class="titulo-pagina">Comunicados de Prácticas Profesionales</h2>
    <!--Comunicados para coordinador (todos)-->
    @if (rol == 2)
    {
        <!-- Coordinador -->
        <div class="d-flex justify-content-end gap-3 mb-4">
            <button class="btn-ver" data-bs-toggle="modal" data-bs-target="#modalAgregarComunicado">
                <i class="bi bi-plus-circle"></i> Agregar Comunicado
            </button>
            <button class="btn-ver" data-bs-toggle="modal" data-bs-target="#modalEnviarCorreo">
                <i class="bi bi-envelope-fill"></i> Enviar Email
            </button>
        </div>

        <div class="row g-4" id="contenedorComunicados">

            @if (Model.AllComunicados != null && Model.AllComunicados.Any())
            {
                @foreach (var c in Model.AllComunicados)
                {
                    <div class="col-12 col-sm-6 col-lg-3 d-flex" id="comunicado-@c.IdComunicado">
                        <div class="card w-100 shadow-sm">
                            <div class="card-body d-flex flex-column card-comunicado-body">

                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title fw-bold mb-0">@c.Nombre</h6>

                                    @if (c.IdEstado != 1)
                                    {
                                        <span class="badge bg-danger">Inactivo</span>
                                    }
                                </div>

                                <p class="text-muted mb-3">
                                    <strong>Publicado:</strong> @c.Fecha.ToString("dd/MM/yyyy")
                                </p>

                                <div class="mt-auto text-center">
                                    <button type="button"
                                            class="btn btn-sm btn-ver btn-abrir-comunicado"
"
                                            data-bs-toggle="modal"
                                            data-bs-target="#modalComunicadoUnico"
                                            data-id="@c.IdComunicado"
                                            data-titulo="@c.Nombre"
                                            data-descripcion="@c.Informacion"
                                            data-fecha="@c.Fecha.ToString("dd/MM/yyyy")"
                                            data-aplicacion="@(c.FechaLimite.HasValue? c.FechaLimite.Value.ToString("yyyy-MM-dd") : "N/A")"
                                            data-publicado="@c.PublicadoPor"
                                            data-dirigido="@c.Poblacion"
                                            data-estado="@c.IdEstado">
                                        
                                        Abrir
                                    </button>
                                </div>

                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12 text-center text-muted">
                    <p>No hay comunicados disponibles.</p>
                </div>
            }

        </div>

    }

    <!--Comunicados estudiante y general-->
    @if (rol == 1)
    {
        <div class="row g-4" id="contenedorComunicadosEstudiantes">

            @if (Model.ComunicadosEstudiantes != null && Model.ComunicadosEstudiantes.Any())
            {
                @foreach (var c in Model.ComunicadosEstudiantes)
                {
                    <div class="col-12 col-sm-6 col-lg-3 d-flex" id="comunicado-@c.IdComunicado">
                        <div class="card w-100 shadow-sm">
                            <div class="card-body d-flex flex-column card-comunicado-body">

                                <h6 class="card-title fw-bold">@c.Nombre</h6>

                                <p class="text-muted mb-3">
                                    <strong>Publicado:</strong> @c.Fecha.ToString("dd/MM/yyyy")
                                </p>

                                <div class="mt-auto text-center">
                                    <button type="button"
                                            class="btn btn-sm btn-ver btn-abrir-comunicado"
                                            data-bs-toggle="modal"
                                            data-bs-target="#modalComunicadoUnico"
                                            data-id="@c.IdComunicado"
                                            data-titulo="@c.Nombre"
                                            data-descripcion="@c.Informacion"
                                            data-fecha="@c.Fecha.ToString("dd/MM/yyyy")"
                                            data-aplicacion="@(c.FechaLimite.HasValue? c.FechaLimite.Value.ToString("yyyy-MM-dd") : "N/A")"
                                            data-publicado="@c.PublicadoPor"
                                            data-dirigido="@c.Poblacion"
                                            data-estado="@c.IdEstado">
                                        Abrir
                                    </button>
                                </div>

                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12 text-center text-muted">
                    <p>No hay comunicados para estudiantes.</p>
                </div>
            }

        </div>

    }

    
   
</div>

<!-- Modal Enviar Correo -->
<div class="modal fade" id="modalEnviarCorreo" tabindex="-1" aria-labelledby="modalEnviarCorreoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius:10px; background-color:#F9F9F9;">
            <div class="modal-header" style="background-color:#2D594D; color:white;">
                <h5 class="modal-title" id="modalEnviarCorreoLabel"><i class="bi bi-envelope-fill"></i> Enviar Correo Electrónico</h5>
            </div>
            <div class="modal-body">
                <form id="formEnviarCorreo" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label class="form-label"><strong>Población:</strong></label>
                        <select class="form-control" id="correoPoblacion" name="PoblacionCorreo" required>
                            <option value="">Seleccione población</option>
                            <option value="Administrativos">Administrativos</option>
                            <option value="Estudiantes">Estudiantes</option>
                            <option value="General">General</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Asunto:</strong></label>
                        <input type="text" class="form-control" id="correoAsunto" name="AsuntoCorreo" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Mensaje:</strong></label>
                        <textarea class="form-control" id="correoMensaje" name="MensajeCorreo" rows="5" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Adjuntar Archivo:</strong></label>
                        <input type="file" class="form-control" id="correoArchivo" name="Archivo" multiple />
                        <small class="text-muted">PDF, DOCX, XLSX (opcional).</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="btnEnviar" class="btn-ver">Enviar Correo</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Agregar Comunicado -->
<div class="modal fade" id="modalAgregarComunicado" tabindex="-1" aria-labelledby="modalAgregarLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius:10px; background-color:#F9F9F9;">
            <div class="modal-header" style="background-color:#2D594D; color:white;">
                <h5 class="modal-title" id="modalAgregarLabel">Agregar Comunicado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <form id="formComunicado"
                      asp-action="AgregarComunicado"
                      asp-controller="Comunicados"
                      method="post"
                      enctype="multipart/form-data">

                    @Html.AntiForgeryToken()

                    <div class="mb-3">
                        <label class="form-label fw-bold">Título</label>
                        <input type="text" class="form-control" name="Nombre" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Descripción</label>
                        <textarea class="form-control" name="Informacion" rows="5" ></textarea>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Fecha de Publicación</label>
                            <input type="text" class="form-control"
                                   name="Fecha"
                                   value="@DateTime.Now.ToString("yyyy-MM-dd")"
                                   readonly>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Fecha Límite (si aplica)</label>
                            <input type="date" class="form-control" name="FechaLimite">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">¿Quién puede visualizarlo?</label>
                        <select class="form-control" name="Poblacion" required>
                            <option value="General">General</option>
                            <option value="Administrativos">Administrativos</option>
                            <option value="Estudiantes">Estudiantes</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Documento adjunto</label>
                        <input type="file" class="form-control" name="archivos" multiple>
                    </div>


                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" id="btnGuardarComunicado" class="btn-ver">Guardar Comunicado</button>
                    </div>
                </form>

            </div>

         
        </div>
    </div>
</div>

<!-- Modal Editar Comunicado-->

<div class="modal fade" id="modalEditarComunicado" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius:10px; background-color:#F9F9F9;">
            <div class="modal-header" style="background-color:#2D594D; color:white;">
                <h5 class="modal-title" id="modalEditarLabel">Editar Comunicado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <form id="formEditarComunicado" asp-action="EditarComunicado" asp-controller="Comunicados" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()

                    <!-- ID oculto -->
                    <input type="hidden" id="IdComunicadoEditar" name="IdComunicado" />

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label fw-bold">Título</label>
                            <input type="text" class="form-control" id="TituloComunicadoEditar" asp-for="Nombre">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Descripción</label>
                        <textarea class="form-control" id="DescripcionComunicadoEditar" rows="5" asp-for="Informacion"></textarea>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Fecha de Publicación</label>
                            <input type="text" class="form-control" id="FechaPublicacionComunicadoEditar" asp-for="Fecha" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Fecha Límite (si aplica)</label>
                            <input type="date" class="form-control" id="FechaAplicacionComunicadoEditar" asp-for="FechaLimite">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">¿Quién puede visualizarlo?</label>
                        <select class="form-control" id="DirigidoAComunicadoEditar" asp-for="Poblacion">
                            <option value="General">General</option>
                            <option value="Estudiantes">Estudiantes</option>
                            <option value="Administrativos">Administrativos</option>
                           
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold" style="color:#2D594D;">Documentos adjuntos</label>
                        <div id="documentosActuales" class="mb-2">
                            <p class="text-muted small">Cargando documentos...</p>
                        </div>

                        <input type="file" class="form-control" id="ArchivoDocEditar" name="archivos" multiple>
                        <small class="text-muted">*Puedes subir nuevos archivos (.xls, .xlsx o .pdf)</small>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" id="btnActualizarComunicado" class="btn-ver btnActualizarComunicado">Guardar Cambios</button>
                    </div>
                </form>
            </div>

           
        </div>
    </div>
</div>

<!-- Modal Detalle -->
<div class="modal fade" id="modalComunicadoUnico" tabindex="-1" aria-labelledby="modalComunicadoUnicoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius:10px; background-color:#F2F2F2;">
            <div class="modal-header" style="background-color:#2D594D; color:white;">
                <h5 class="modal-title" id="modalComunicadoUnicoLabel">Título del Comunicado</h5>
            </div>
            <div class="modal-body">
                <p><strong style="color:#2D594D;">Descripción:</strong><br /><span id="comunicadoDescripcion"></span></p>
                <p><strong style="color:#2D594D;">Fecha de Límite:</strong> <span id="comunicadoAplicacion"></span></p>
                <p><strong style="color:#2D594D;">Fecha de Publicación:</strong> <span id="comunicadoFecha"></span></p>
                <p><strong style="color:#2D594D;">Publicado por:</strong> <span id="comunicadoPublicadoPor"></span></p>
                <p><strong style="color:#2D594D;">Dirigido a:</strong> <span id="comunicadoDirigido"></span></p>
                <hr />
                <p><strong style="color:#2D594D;">Documentos asociados:</strong></p>
                <div id="comunicadoDocumentos">
                    <p>No hay documentos disponibles.</p>
                </div>
            </div>

            <div class="modal-footer">
                @if (rol == 2)
                {
                    <button type="button" class="btn btn-warning btnEditarComunicado" data-bs-toggle="modal" id="BtnEditarComunicado" data-bs-target="#modalEditarComunicado">Editar</button>
                    <form id="formEstadoComunicado" class="d-none" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="IdComunicado" id="IdComunicadoEstado" />
                    </form>
                    <button type="button" class="btn btn-danger btnEliminarComunicado" id="BtnEliminarComunicado">Inactivar</button>
                }
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        let comunicadoActual = null;
        const ROL_USUARIO = @rol;
    </script>
    <script src="~/js/Comunicados/Comunicados.js"></script>
}